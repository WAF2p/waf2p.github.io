{% include lang-vars.html %}

{%- comment -%}
  Flag language switch

  Priority:
  1) If pages provide a shared translation key (front matter: ref), switch to that exact page.
  2) Otherwise, mirror paths:
     - /foo/    <-> /de/foo/
     - /        <-> /de/
  3) If the mirrored/target page does not exist, fall back to the target language home.

  GitHub Pages safe (no plugins) â€“ we search in site.pages + site.documents.
{%- endcomment -%}

{%- assign candidates = site.pages | concat: site.documents -%}

{%- assign other_lang = 'de' -%}
{%- if lang == 'de' -%}{%- assign other_lang = 'en' -%}{%- endif -%}

{%- assign en_url = page.url -%}
{%- assign de_url = page.url -%}

{%- comment -%}1) ref-based mapping{%- endcomment -%}
{%- assign current_ref = page.ref | default: nil -%}
{%- assign other_page = nil -%}
{%- if current_ref and current_ref != '' -%}
  {%- assign other_page = candidates | where: 'ref', current_ref | where: 'lang', other_lang | first -%}
  {%- if other_page and other_page.url -%}
    {%- if other_lang == 'en' -%}
      {%- assign en_url = other_page.url -%}
      {%- assign de_url = page.url -%}
    {%- else -%}
      {%- assign de_url = other_page.url -%}
      {%- assign en_url = page.url -%}
    {%- endif -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%}2) mirrored mapping (only if ref-mapping did not override){%- endcomment -%}
{%- if current_ref == nil or current_ref == '' or other_page == nil -%}
  {%- assign path_no_prefix = page.url -%}
  {%- if lang == 'de' -%}
    {%- assign path_no_prefix = page.url | remove_first: '/de' -%}
    {%- if path_no_prefix == '' -%}{%- assign path_no_prefix = '/' -%}{%- endif -%}
  {%- endif -%}

  {%- assign en_url = path_no_prefix -%}
  {%- assign de_url = '/de' | append: path_no_prefix -%}
  {%- if path_no_prefix == '/' -%}
    {%- assign de_url = '/de/' -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%}3) existence check + fallback{%- endcomment -%}
{%- assign de_exists = candidates | where: 'url', de_url | first -%}
{%- assign en_exists = candidates | where: 'url', en_url | first -%}
{%- if de_url == '/de/' or de_exists -%}{%- else -%}{%- assign de_url = '/de/' -%}{%- endif -%}
{%- if en_url == '/' or en_exists -%}{%- else -%}{%- assign en_url = '/' -%}{%- endif -%}

<div class="lang-switch" aria-label="Language switch">
  <a class="lang-flag{% if lang == 'en' %} is-active{% endif %}" href="{{ en_url | relative_url }}" title="English" aria-label="English">
    <span aria-hidden="true">ðŸ‡¬ðŸ‡§</span>
  </a>
  <a class="lang-flag{% if lang == 'de' %} is-active{% endif %}" href="{{ de_url | relative_url }}" title="Deutsch" aria-label="Deutsch">
    <span aria-hidden="true">ðŸ‡©ðŸ‡ª</span>
  </a>
</div>
